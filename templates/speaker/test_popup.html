{% load static %}
{% load i18n %}

{% block styles %}
    <link href="{% static 'css/pagewise/test-popup.css' %}" rel="stylesheet">
{% endblock %}


<form action="{% url 'speaker:exam_popup' %}"
      enctype="multipart/form-data"
      method="post" id="audio_form">
  {% csrf_token %}
  <!-- record player -->
  <div id="record_player"></div>
  <select name="question" id="id_question" style="display: none;">
    <option value="{{ qn.pk }}" selected>{{ qn.question_title }}</option>
  </select>
  <select name="speaker" id="id_speaker" style="display: none;">
    <option value="{{ speaker.pk }}" selected>{{ speaker.user }}</option>
  </select>

</form>

<section class="top-section">
  <div class="question-count-buttons">
    {% for qn in qn_set.questions.all %}

      <button type="button" class="{% if qn_num == forloop.counter0 %} active-question {% else %} inactive-question{% endif %}">
              {{ forloop.counter }}
      </button>
      <!-- {% if not forloop.last %}&nbsp;&nbsp; > &nbsp;&nbsp;{% endif %} -->

    {% endfor %}
  </div>
  {% if qn.upload_type == "AUD" %}
      <div title="Media Volume" class="media-volume-slider">
        <i class="fa-solid fa-volume-high"></i>
        <input type="range" min="1" max="100" value="50" class="slider" id="volume_slider_input">
      </div>
  {% endif %}
</section>
    
<section class="mid-section">
    <div class="question-parent question-wrapper blur-filter">
      <h6 class=" question-title">
        <span class="" >{{ qn_num1 }}. </span><span> {{ qn.question_title }}</span>
      </h6>
      {% if qn.upload_type == "AUD" %}
        <audio id="qn_audio">
          <source src="{{ qn.upload_file.url }}" type="audio/mpeg">
        </audio>

        <div class="audio-progress-wrapper">
          <div class="progress" style="width: 50%; margin: auto;">
            <div class="progress-bar bg-dark audio-progress" role="progressbar" aria-valuenow="0"
                aria-valuemin="0" aria-valuemax="100" style="width: 0%;">
            </div>
          </div>
          <span><i class="fa-solid fa-circle-play"></i> Audio progress</span>
        </div>
      {% endif %}
      {% if qn.upload_type == "IMG" %}
        <img class="image-question" src="{{ qn.upload_file.url }}" alt="question image">
      {% endif %}
      <p class="question-description">{{ qn.description }}</p>
    </div>

    <audio id="myAudio">
      <source src="{% static 'audio/beep-07a.mp3' %}" type="audio/mpeg">
    </audio>



  {% if prev_qn != None %}
    <button title="Previous question"  onclick="prev_qn_btn_click();" class="btn btn-sm btn-dark prev_qn_btn">
      <i class="fa-solid fa-angles-right" style="transform: rotate(180deg);"></i> {% trans 'Previous' %} 
    </button>
  {% endif %}

  {% if next_qn != None %}
    <button title="Next question" onclick="next_qn_btn_click();" class="btn btn-sm btn-dark next_qn_btn">
        <i class="fa-solid fa-angles-right"></i> {% trans 'Next' %}
    </button>
  {% endif %}


  <button  class="remove-blur-btn" title="Start Question">Start</button>

</section>


<section class="bottom-section">
  <div class="recorder_wave" style="width: 15rem; height: 3rem;">
    <svg preserveAspectRatio="none" id="visualizer" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
      <defs>

        <mask id="mask">
          <g id="maskGroup">
          </g>
        </mask>
        <linearGradient id="gradient" x1="0%" y1="0%" x2="0%" y2="100%">
          <stop offset="0%" style="stop-color:#ff0a0a;stop-opacity:1" />
          <stop offset="20%" style="stop-color:#f1ff0a;stop-opacity:1" />
          <stop offset="90%" style="stop-color:#d923b9;stop-opacity:1" />
          <stop offset="100%" style="stop-color:#050d61;stop-opacity:1" />
        </linearGradient>
      </defs>
      <rect x="0" y="0" width="100%" height="100%" fill="url(#gradient)" mask="url(#mask)"></rect>

    </svg>
    <h1></h1>
  </div>
    <!-- <h1>In <a href="https://codepen.io/zapplebee/full/gbNbZE/">Full Page view</a>, please allow the use of your microphone</h1> -->

  <div class="progress-buttons">
    <!-- {#      <div class="col-12">#} -->
    <!-- <div id="controls">
      <button type="button" id="recordButton">Record</button>
      <button type="button" id="pauseButton" disabled>Pause</button>
      <button type="button" id="stopButton" disabled>Stop</button>
    </div> -->

    <div class="prep_button_div">
      <i class="fa-solid fa-stopwatch prep-icon status-active"></i>
      <span id='prep_btn' class="prep-label status-active">{% trans 'Preparation' %}</span>
      <span class="prep-timer status-active"></span>
    </div>

    <div class="rec_button_div">
      <i class="fa-solid fa-microphone-lines rec-icon status-inactive"></i>
      <span id='recording_btn' class="rec-label status-inactive ">{% trans 'Recording' %}</span>
      <span class="rec-timer status-inactive"></span>
    </div>


  </div>

</section>

<!--Recorder-->

<script>
  $("#test_modal_label").html("{{ qn_set.name }}");
  function prev_qn_btn_click(){
    let qn_set_pk = "{{ qn_set.pk }}";
    let qn_num = "{{ prev_qn }}"
    $.ajax({
      type: "GET",
      url: `{% url 'speaker:exam_popup' %}?qn_set=${qn_set_pk}&qn_num=${qn_num}`,
      success: function (response){
        $("#test_modal_body").html(response);
      },
      error: function () {
        console.log('Error');
      },
      complete: function () {
        $(".loading-icon-ajax").fadeOut("fast");
      }
    });
  }

  function next_qn_btn_click(){
    let qn_set_pk = "{{ qn_set.pk }}";
    let qn_num = "{{ next_qn }}"
    $.ajax({
      type: "GET",
      url: `{% url 'speaker:exam_popup' %}?qn_set=${qn_set_pk}&qn_num=${qn_num}`,
      success: function (response){
        $("#test_modal_body").html(response);
      },
      error: function () {
        console.log('Error');
      },
      complete: function () {
        $(".loading-icon-ajax").fadeOut("fast");
      }
    });
  }

  function toHHMMSS (ip_sec) {
    var sec_num = parseInt(ip_sec, 10); // don't forget the second param
    var hours   = Math.floor(sec_num / 3600);
    var minutes = Math.floor((sec_num - (hours * 3600)) / 60);
    var seconds = sec_num - (hours * 3600) - (minutes * 60);

    if (hours   < 10) {hours   = "0"+hours;}
    if (minutes < 10) {minutes = "0"+minutes;}
    if (seconds < 10) {seconds = "0"+seconds;}
    return minutes+':'+seconds;
  }

  $(".btn-close").click(function(){
    location.reload();
  });





</script>
<!--Recorder testing from here-->
<script>
  $(document).ready(function(){

    $(".remove-blur-btn").click(function(){
      removeBlur();
    });
    // Remove background blur from the main question section on clicking the Start button
  function removeBlur(){
    document.querySelector('.question-parent').classList.remove('blur-filter');
    document.querySelector('.remove-blur-btn').style.display = "none";

    startPreparationTimer();
  }

    {% if qn.can_submit %}


    

      prepTimeLimit = parseInt("{{ qn.ready_time }}");
      prepTimePassed = 0;
      prepTimeLeft = prepTimeLimit;
      recTimeLimit = parseInt("{{ qn.speaking_time }}");
      recTimePassed = 0;
      recTimeLeft = recTimeLimit;
      $(".prep-timer").html(`${toHHMMSS(prepTimeLeft)}`);
      $(".rec-timer").html(`${toHHMMSS(recTimeLeft)}`);


      $(".prev_qn_btn").attr("disabled", "disabled");
      $(".next_qn_btn").attr("disabled", "disabled");
      // $(".recorder_wave h1").html("{% trans 'Preparation' %}...");
      // $('#prep_btn').removeClass('btn-outline-info');
      // $('#prep_btn').addClass('btn-info');
      // prepTimeout = setTimeout(startWave, 5000);

      function startPreparationTimer(){
        if (!(typeof prepInterval === 'undefined')){
          clearInterval(prepInterval);
        }
        // When student takes test, prevent closing/interruption of the test
        document.querySelector('.btn-close').style.display = "none";

        prepInterval = setInterval(() => {
          prepTimePassed = prepTimePassed + 1;
          prepTimeLeft = prepTimeLimit - prepTimePassed;
          if (prepTimeLeft <= 0) {
            clearInterval(prepInterval);
            startWave();
          }
          $(".prep-timer").html(`${toHHMMSS(prepTimeLeft)}`);
          // debugger;

        }, 1000);
      }

      function playBeepSound() {
        // var audio = new Audio('orgadmin/static/audio/beep-07a.mp3');
        // audio.play();

        var x = document.getElementById("myAudio"); 
        x.play(); 
      }



      function startWave(){
        playBeepSound()
        $('.question-wrapper').removeClass('blur-filter');
        $('.prep-label').removeClass('status-active');
        $('.prep-label').addClass('status-inactive');
        $('.prep-icon').removeClass('status-active');
        $('.prep-icon').addClass('status-inactive');
        $('.rec-label').removeClass('status-inactive');
        $('.rec-label').addClass('status-active');
        $('.rec-icon').removeClass('status-inactive');
        $('.rec-icon').addClass('status-active');
        $('.prep-timer').removeClass('status-active');
        $('.prep-timer').addClass('status-inactive');
        $('.rec-timer').removeClass('status-inactive');
        $('.rec-timer').addClass('status-active');
        // var paths = document.getElementsByTagName('path');
        // var visualizer = document.getElementById('visualizer');
        // var mask = visualizer.getElementById('mask');
        // var h = document.getElementsByTagName('h1')[0];
        // var path;
        // var report = 0;

        paths = document.getElementsByTagName('path');
        visualizer = document.getElementById('visualizer');
        mask = visualizer.getElementById('mask');
        h = document.getElementsByTagName('h1')[0];
        // path;
        report = 0;
        record_state =true;
        soundAllowed = function (stream) {
          //Audio stops listening in FF without // window.persistAudioStream = stream;
          //https://bugzilla.mozilla.org/show_bug.cgi?id=965483
          //https://support.mozilla.org/en-US/questions/984179
          window.persistAudioStream = stream;
          // h.innerHTML = "Thanks";
          h.setAttribute('style', 'opacity: 0;');
          var audioContent = new AudioContext();
          var audioStream = audioContent.createMediaStreamSource( stream );
          var analyser = audioContent.createAnalyser();
          audioStream.connect(analyser);
          analyser.fftSize = 1024;

          var frequencyArray = new Uint8Array(analyser.frequencyBinCount);
          visualizer.setAttribute('viewBox', '0 0 255 255');

          //Through the frequencyArray has a length longer than 255, there seems to be no
          //significant data after this point. Not worth visualizing.
          for (var i = 0 ; i < 255; i++) {
            path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            path.setAttribute('stroke-dasharray', '4,1');
            mask.appendChild(path);
          }
          var doDraw = function () {
            if (record_state){
              requestAnimationFrame(doDraw);
            }
            analyser.getByteFrequencyData(frequencyArray);
            var adjustedLength;
            for (var i = 0 ; i < 255; i++) {
              adjustedLength = Math.floor(frequencyArray[i]) - (Math.floor(frequencyArray[i]) % 5);
              paths[i].setAttribute('d', 'M '+ (i) +',255 l 0,-' + adjustedLength);
            }

          }
          doDraw();
        }

        soundNotAllowed = function (error) {
          h.innerHTML = "{% trans 'No mic' %}";
          console.log(error);
        }

        /*window.navigator = window.navigator || {};
        /*navigator.getUserMedia =  navigator.getUserMedia       ||
                                  navigator.webkitGetUserMedia ||
                                  navigator.mozGetUserMedia    ||
                                  null;*/

        start_wave = function (){
          navigator.getUserMedia({audio:true}, soundAllowed, soundNotAllowed);
        }
        start_wave();
        startRecording();
        // rec.record();
        //setTimeout(stopWave, 7000)

        startRecordTimer();

        function stopWave(){
          record_state = false;
          start_wave();
          stopRecording();
          on_form_submit();
          $("#visualizer").hide();
          $(".prev_qn_btn").removeAttr("disabled");
          $(".next_qn_btn").removeAttr("disabled");
          $('#recording_btn').removeClass('btn-info')
          $('#recording_btn').addClass('btn-outline-info')
          // When recording stops, allow closing/interruption of the test
          document.querySelector('.btn-close').style.display = "block";

        }

        function startRecordTimer(){
          if (!(typeof recInterval === 'undefined')){
            clearInterval(recInterval);
          }

          recInterval = setInterval(() => {
            recTimePassed = recTimePassed + 1;
            recTimeLeft = recTimeLimit - recTimePassed;
            if (recTimeLeft <= 0) {
              clearInterval(recInterval);
              stopWave();
            }
            $(".rec-timer").html(`${toHHMMSS(recTimeLeft)}`);
            // debugger;

          }, 1000);
        }

      }

      // startPreparationTimer();
      {% if qn.upload_type == "AUD" %}
        $("#qn_audio").prop("volume", 1.0);
        audioTimeLimit = Math.ceil(document.getElementById("qn_audio").duration);
        audioTimePassed = 0;
        audioTimeLeft = audioTimeLimit;

        function startAudioPlayerTimer(){
          if (!(typeof audioInterval === 'undefined')){
            clearInterval(audioInterval);
          }

          audioInterval = setInterval(() => {
            audioTimePassed = audioTimePassed + 1;
            audioTimeLeft = audioTimeLeft - audioTimePassed;
            if (audioTimeLeft <= 0) {
              clearInterval(audioInterval);

              // startWave();
            }
            // $(".prep-timer").html(`${toHHMMSS(prepTimeLeft)}`);
            audioTimeLimit = Math.ceil(document.getElementById("qn_audio").duration);
            audioPercent = parseInt(audioTimePassed * 100 / audioTimeLimit );
            $(".audio-progress").attr("aria-valuenow", String(audioPercent));
            $(".audio-progress").css("width", String(audioPercent)+"%");

            // debugger;

          }, 1000);
        }

        startAudioPlayerTimer();
        $("#qn_audio").get(0).play();

        $("#volume_slider_input").on( "input", function() {
          // use ui.value to get the current value
          let volume = parseFloat($(this).val()) / 100.0;
          $("#qn_audio").prop("volume", volume);
        });

      {% endif %}

      {% else %}

        // Remove blur-filter effect and Start button from the question if its already submitted
        document.querySelector('.question-parent').classList.remove('blur-filter');
        document.querySelector('.remove-blur-btn').style.display = "none";

      
    {% endif %}
  });

</script>
