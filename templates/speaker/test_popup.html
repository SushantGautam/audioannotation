{% load static %}
{% load i18n %}

<style>
    svg{
        display: block;
        width: 100%;
        height: 100%;
        padding: 0;
        margin: auto;
        /* position:absolute; */
    }

    path{
        stroke-linecap: square;
        stroke: white;
        stroke-width: 0.5px;
    }

    h1{
        color: white;
        margin-top: -35px;
        font-size: 1.2rem;

    }
    #record_player{
        display: none;
    }


</style>
<form action="{% url 'speaker:exam_popup' %}"
      enctype="multipart/form-data"
      method="post" id="audio_form">
  {% csrf_token %}
  <!-- record player -->
  <div id="record_player"></div>
  <select name="question" id="id_question" style="display: none;">
    <option value="{{ qn.pk }}" selected>{{ qn.question_title }}</option>
  </select>
  <select name="speaker" id="id_speaker" style="display: none;">
    <option value="{{ speaker.pk }}" selected>{{ speaker.user }}</option>
  </select>

</form>
<div class="row" style="padding: 12px">
  <div class="col-12" style="background-color: #f3f3f3; padding: 10px">
    {% for qn in qn_set.questions.all %}

      <button type="button"
              style="display: inline-flex"
              class="btn
              {% if qn_num == forloop.counter0 %}
                btn-info
              {% else %}
                btn-outline-info
              {% endif %}">{{ forloop.counter }}</button>
      {% if not forloop.last %}&nbsp;&nbsp; > &nbsp;&nbsp;{% endif %}

    {% endfor %}
  </div>
</div>

<div class="row" style="height: 60%">
  <div class="col-2" style="display: flex">
    {% if prev_qn != None %}
      <button type="button"
              style="margin: auto;"
              onclick="prev_qn_btn_click();"
              class="btn btn-primary prev_qn_btn">{% trans 'Previous' %}</button>
    {% endif %}
  </div>
  <div class="col-8">
    {#    <div class="row">#}
    <div class="col-12">
      <span>{{ qn_num1 }}. </span><span> {{ qn.question_title }}</span>
    </div>
    {#    </div>#}
    {#    <div class="row">#}
    <div class="col-12" style="margin-top: 20px;
    height: 80%;
    text-align: center;
    justify-content: center;
    border: 1px solid black;">
      <span style="margin: auto;">{{ qn.description }}</span>

      {% if qn.upload_type == "AUD" %}
        <audio id="qn_audio">
          <source src="{{ qn.upload_file.url }}" type="audio/mpeg">
        </audio>
        <div class="progress" style="width: 50%; margin: auto;">
          <div class="progress-bar audio_progress" role="progressbar" aria-valuenow="0"
               aria-valuemin="0" aria-valuemax="100" style="width: 0%;"></div>
        </div>
      {% endif %}
    {% if qn.upload_type == "IMG" %}
      <div>
        <img src="{{ qn.upload_file.url }}"
             style="width: 70%"
             alt="question image">
      </div>
    {% endif %}

    </div>
    {#    </div>#}

  </div>
  <div class="col-2" style="display: flex">
    {% if next_qn != None %}
      <button type="button"
              style="margin: auto;"
              onclick="next_qn_btn_click();"
              class="btn btn-primary next_qn_btn">{% trans 'Next' %}</button>
    {% endif %}
  </div>
</div>

<div class="row" style="height: 30%; padding: 0 12px 21px 12px;">
  {#  <div class="col-12" style="height: 33%; background-color: #f3f3f3;">#}
  <div class="col-4" style="text-align: center; margin: auto; height: 100%; display: flex; background-color: #f3f3f3">
    <div class="recorder_wave"
         style="width: 80%; height: 60%; border: solid black; margin: auto; background-color: #360752">
      <svg preserveAspectRatio="none" id="visualizer" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
        <defs>

          <mask id="mask">
            <g id="maskGroup">
            </g>
          </mask>
          <linearGradient id="gradient" x1="0%" y1="0%" x2="0%" y2="100%">
            <stop offset="0%" style="stop-color:#ff0a0a;stop-opacity:1" />
            <stop offset="20%" style="stop-color:#f1ff0a;stop-opacity:1" />
            <stop offset="90%" style="stop-color:#d923b9;stop-opacity:1" />
            <stop offset="100%" style="stop-color:#050d61;stop-opacity:1" />
          </linearGradient>
        </defs>
        <rect x="0" y="0" width="100%" height="100%" fill="url(#gradient)" mask="url(#mask)"></rect>

      </svg>
      <h1></h1>
    </div>
    <!-- <h1>In <a href="https://codepen.io/zapplebee/full/gbNbZE/">Full Page view</a>, please allow the use of your microphone</h1> -->
  </div>
  <div class="col-4" style="text-align: center; height: 100%; margin: auto; display: flex; background-color: #f3f3f3">
    {#      <div class="col-12">#}
    <!-- <div id="controls">
      <button type="button" id="recordButton">Record</button>
      <button type="button" id="pauseButton" disabled>Pause</button>
      <button type="button" id="stopButton" disabled>Stop</button>
    </div> -->

    <div class="prep_button_div">
      <button id='prep_btn' type="button" style="margin: auto; border-radius: 50%"
              class="btn btn-outline-info">{% trans 'Preparation' %}</button>
      <div class="prep_timer_div"></div>
    </div>
    <div class="rec_button_div">
      <button id='recording_btn' type="button"  style="margin: auto; border-radius: 50%"
              class="btn btn-outline-info ml-5">{% trans 'Recording' %}</button>
      <div class="rec_timer_div"></div>
    </div>


    {#      </div>#}

  </div>
  <div class="col-4" style="display: flex; background-color: #f3f3f3"></div>
  {#  </div>#}
</div>

<!--Recorder-->
{#  <script type="module" src="{% static 'js/recorder/index.js' %}"></script>#}
<!-- <script src="{% static 'js/recorder/recorder.js' %}"></script>
<script src="{% static 'js/recorder/app.js' %}"></script> -->

{#<script>#}
{#  //Timer test#}
{#  prepTimeout = setTimeout(startWave, 5000);#}
{#  function startWave(){#}
{#    $('#prep_btn').removeClass('btn-info')#}
{#    $('#prep_btn').addClass('btn-outline-info')#}
{#    $('#recording_btn').removeClass('btn-outline-info')#}
{#    $('#recording_btn').addClass('btn-info')#}
{#  }#}
{#</script>#}
<script>
  $("#test_modal_label").html("{{ qn_set.name }}");
  function prev_qn_btn_click(){
    let qn_set_pk = "{{ qn_set.pk }}";
    let qn_num = "{{ prev_qn }}"
    $.ajax({
      type: "GET",
      url: `{% url 'speaker:exam_popup' %}?qn_set=${qn_set_pk}&qn_num=${qn_num}`,
      success: function (response){
        $("#test_modal_body").html(response);
      },
      error: function () {
        console.log('Error');
      },
      complete: function () {
        $(".loading-icon-ajax").fadeOut("fast");
      }
    });
  }

  function next_qn_btn_click(){
    let qn_set_pk = "{{ qn_set.pk }}";
    let qn_num = "{{ next_qn }}"
    $.ajax({
      type: "GET",
      url: `{% url 'speaker:exam_popup' %}?qn_set=${qn_set_pk}&qn_num=${qn_num}`,
      success: function (response){
        $("#test_modal_body").html(response);
      },
      error: function () {
        console.log('Error');
      },
      complete: function () {
        $(".loading-icon-ajax").fadeOut("fast");
      }
    });
  }

  function toHHMMSS (ip_sec) {
    var sec_num = parseInt(ip_sec, 10); // don't forget the second param
    var hours   = Math.floor(sec_num / 3600);
    var minutes = Math.floor((sec_num - (hours * 3600)) / 60);
    var seconds = sec_num - (hours * 3600) - (minutes * 60);

    if (hours   < 10) {hours   = "0"+hours;}
    if (minutes < 10) {minutes = "0"+minutes;}
    if (seconds < 10) {seconds = "0"+seconds;}
    return minutes+':'+seconds;
  }

  $(".btn-close").click(function(){
    location.reload();
  });

</script>
<!--Recorder testing from here-->
<script>
  $(document).ready(function(){

    {% if qn.can_submit %}

      prepTimeLimit = parseInt("{{ qn.ready_time }}");
      prepTimePassed = 0;
      prepTimeLeft = prepTimeLimit;
      recTimeLimit = parseInt("{{ qn.speaking_time }}");
      recTimePassed = 0;
      recTimeLeft = recTimeLimit;
      $(".prep_timer_div").html(`${toHHMMSS(prepTimeLeft)}`);
      $(".rec_timer_div").html(`${toHHMMSS(recTimeLeft)}`);


      $(".prev_qn_btn").attr("disabled", "disabled");
      $(".next_qn_btn").attr("disabled", "disabled");
      $(".recorder_wave h1").html("{% trans 'Preparation' %}...");
      $('#prep_btn').removeClass('btn-outline-info');
      $('#prep_btn').addClass('btn-info');
      // prepTimeout = setTimeout(startWave, 5000);

      function startPreparationTimer(){
        if (!(typeof prepInterval === 'undefined')){
          clearInterval(prepInterval);
        }

        prepInterval = setInterval(() => {
          prepTimePassed = prepTimePassed + 1;
          prepTimeLeft = prepTimeLimit - prepTimePassed;
          if (prepTimeLeft <= 0) {
            clearInterval(prepInterval);
            startWave();
          }
          $(".prep_timer_div").html(`${toHHMMSS(prepTimeLeft)}`);
          // debugger;

        }, 1000);
      }

      function startWave(){
        $('#prep_btn').removeClass('btn-info');
        $('#prep_btn').addClass('btn-outline-info');
        $('#recording_btn').removeClass('btn-outline-info');
        $('#recording_btn').addClass('btn-info');
        // var paths = document.getElementsByTagName('path');
        // var visualizer = document.getElementById('visualizer');
        // var mask = visualizer.getElementById('mask');
        // var h = document.getElementsByTagName('h1')[0];
        // var path;
        // var report = 0;

        paths = document.getElementsByTagName('path');
        visualizer = document.getElementById('visualizer');
        mask = visualizer.getElementById('mask');
        h = document.getElementsByTagName('h1')[0];
        // path;
        report = 0;
        record_state =true;
        soundAllowed = function (stream) {
          //Audio stops listening in FF without // window.persistAudioStream = stream;
          //https://bugzilla.mozilla.org/show_bug.cgi?id=965483
          //https://support.mozilla.org/en-US/questions/984179
          window.persistAudioStream = stream;
          // h.innerHTML = "Thanks";
          h.setAttribute('style', 'opacity: 0;');
          var audioContent = new AudioContext();
          var audioStream = audioContent.createMediaStreamSource( stream );
          var analyser = audioContent.createAnalyser();
          audioStream.connect(analyser);
          analyser.fftSize = 1024;

          var frequencyArray = new Uint8Array(analyser.frequencyBinCount);
          visualizer.setAttribute('viewBox', '0 0 255 255');

          //Through the frequencyArray has a length longer than 255, there seems to be no
          //significant data after this point. Not worth visualizing.
          for (var i = 0 ; i < 255; i++) {
            path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            path.setAttribute('stroke-dasharray', '4,1');
            mask.appendChild(path);
          }
          var doDraw = function () {
            if (record_state){
              requestAnimationFrame(doDraw);
            }
            analyser.getByteFrequencyData(frequencyArray);
            var adjustedLength;
            for (var i = 0 ; i < 255; i++) {
              adjustedLength = Math.floor(frequencyArray[i]) - (Math.floor(frequencyArray[i]) % 5);
              paths[i].setAttribute('d', 'M '+ (i) +',255 l 0,-' + adjustedLength);
            }

          }
          doDraw();
        }

        soundNotAllowed = function (error) {
          h.innerHTML = "{% trans 'No mic' %}";
          console.log(error);
        }

        /*window.navigator = window.navigator || {};
        /*navigator.getUserMedia =  navigator.getUserMedia       ||
                                  navigator.webkitGetUserMedia ||
                                  navigator.mozGetUserMedia    ||
                                  null;*/

        start_wave = function (){
          navigator.getUserMedia({audio:true}, soundAllowed, soundNotAllowed);
        }
        start_wave();
        startRecording();
        // rec.record();
        //setTimeout(stopWave, 7000)

        startRecordTimer();

        function stopWave(){
          record_state = false;
          start_wave();
          stopRecording();
          on_form_submit();
          $("#visualizer").hide();
          $(".prev_qn_btn").removeAttr("disabled");
          $(".next_qn_btn").removeAttr("disabled");
          $('#recording_btn').removeClass('btn-info')
          $('#recording_btn').addClass('btn-outline-info')
        }

        function startRecordTimer(){
          if (!(typeof recInterval === 'undefined')){
            clearInterval(recInterval);
          }

          recInterval = setInterval(() => {
            recTimePassed = recTimePassed + 1;
            recTimeLeft = recTimeLimit - recTimePassed;
            if (recTimeLeft <= 0) {
              clearInterval(recInterval);
              stopWave();
            }
            $(".rec_timer_div").html(`${toHHMMSS(recTimeLeft)}`);
            // debugger;

          }, 1000);
        }

      }

      startPreparationTimer();
      {% if qn.upload_type == "AUD" %}
        audioTimeLimit = Math.ceil(document.getElementById("qn_audio").duration);
        audioTimePassed = 0;
        audioTimeLeft = audioTimeLimit;

        function startAudioPlayerTimer(){
          if (!(typeof audioInterval === 'undefined')){
            clearInterval(audioInterval);
          }

          audioInterval = setInterval(() => {
            audioTimePassed = audioTimePassed + 1;
            audioTimeLeft = audioTimeLeft - audioTimePassed;
            if (audioTimeLeft <= 0) {
              clearInterval(audioInterval);

              // startWave();
            }
            // $(".prep_timer_div").html(`${toHHMMSS(prepTimeLeft)}`);
            audioTimeLimit = Math.ceil(document.getElementById("qn_audio").duration);
            audioPercent = parseInt(audioTimePassed * 100 / audioTimeLimit );
            $(".audio_progress").attr("aria-valuenow", String(audioPercent));
            $(".audio_progress").css("width", String(audioPercent)+"%");

            // debugger;

          }, 1000);
        }

        startAudioPlayerTimer();
        $('#qn_audio').get(0).play();
      {% endif %}

    {% endif %}
  });

</script>
