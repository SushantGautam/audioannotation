{% extends "orgadmin/base.html" %}
{% load static %}
{% load i18n %}

{% block styles %}
    <style>
        main {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        section {
            margin-block: 1rem;
        }

        .title {
            font-weight: 500;
        }

        .users {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(14rem, 1fr));
            gap: 1rem;
            background-color: white;
            /* padding-block: 1rem; */
        }

        .users a {
            all: unset;
            cursor: pointer;
        }

        .user-card:hover {
            background-color: #444444;
            color: #f0f0f0;
        }

        .user-card.active {
            background-color: #444444;
            color: #f0f0f0;
            box-shadow: 1px 1px 10px 2px rgba(0, 0, 0, 0.2);
        }

        .user-card {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            border: 2.5px solid lightgrey;
            transition: all 0.3s ease-in-out;
        }

        .user-card .right-side {
            display: flex;
            flex-direction: column;
        }

        .new-additions, .time {
            display: flex;
            flex-direction: column;
            padding: 0rem 0.45rem 0 0.25rem;
            font-size: 0.9rem;
            font-weight: 500;
            border-radius: 0.25rem;
            background-color: rgba(0, 0, 0, 0.05);
            color: #0ab2a9;
        }

        .count {
            font-weight: 600;
            font-size: 1.5rem;
        }


        td a {
            all: unset;
            cursor: pointer;
            font-weight: bold;
        }
        td a:hover {
            all: unset;
            cursor: pointer;
            font-weight: bold;
        }


        .speaker_info_col{
            border: 1px solid #6c7a86;
            padding: 5px;
            margin-bottom: 10px;
        }

        .speaker .title {
          /* display: flex; */
          background-color: rgba(188,188,188,0.2);
          justify-content: center;
          align-items: center;
          font-weight: 600;
         /* width: 20%; */
      }

         .dt_right_btn{
            float: right;
        }
    </style>
{% endblock %}

{% block content %}

    <section>
        <h2 class="my-3 title">{% trans 'Speaker Result' %}</h2>
        <div class="users">
            <a href="{% url 'speaker_result' object.id %}">
                <div class="user-card {% if not request.GET.status %}active{% endif %}">
                    <div class="right-side text-center">
                        <div>
                            <span class="count"> {{ tq_count }}</span>
                        </div>
                        <span class="title"> {% trans 'Total Questions' %}</span>
                    </div>
                </div>
            </a>
            <a href="{% url 'speaker_result' object.id %}?status=solved">
                <div class="user-card {% if request.GET.status == 'solved' %}active{% endif %}">
                    <div class="right-side">
                        <div>
                            <span class="count">{{ sq_count }}</span>
                        </div>
                        <span class="title"> {% trans 'Solved Questions' %}</span>
                    </div>
                </div>
            </a>
            <a href="{% url 'speaker_result' object.id %}?status=unsolved">
                <div class="user-card {% if request.GET.status == 'unsolved' %}active{% endif %}">
                    <div class="right-side">
                        <div>
                            <span class="count">{{ uq_count }}</span>
                        </div>
                        <span class="title"> {% trans 'Unsolved Questions' %}</span>
                    </div>
                </div>
            </a>
        </div>
    </section>

    <main class="users-list">

         <section class="speaker_info">
             <div class="speaker row speaker_info_table_row ">
             <div class="col-md-6 d-flex speaker_info_col">
                <div class="title col-4 speaker_info_table_th">{% trans 'Speaker ID' %}</div>
                <div class="value col-8 speaker_info_table_td text-center"> {{ object.user.email }}</div>
             </div>
             <div class="col-md-6 d-flex speaker_info_col">
                <div class="title col-4 speaker_info_table_th">{% trans 'Full Name' %}</div>
                <div class="value col-8 speaker_info_table_td text-center">{{ object.user.get_full_name }}</div>
             </div>

          </div>
           <div class="speaker row speaker_info_table_row ">
             <div class="col-md-6 d-flex speaker_info_col">
                <div class="title col-4 speaker_info_table_th">{% trans 'Level' %}</div>
                <div class="value col-8 speaker_info_table_td text-center"> {{ object.get_level_display }}</div>
             </div>
             <div class="col-md-6 d-flex speaker_info_col">
                <div class="title col-4 speaker_info_table_th">{% trans 'Native Language' %}</div>
                <div class="value col-8 speaker_info_table_td text-center">{{ object.get_language_display }} </div>
             </div>

          </div>
           <div class="speaker row speaker_info_table_row">
{#             <div class="col-md-6 d-inline-flex speaker_info_col">#}
{#                <div class="title col-4 speaker_info_table_th">Exam Title</div>#}
{#                <div class="value col-8 speaker_info_table_td text-right text-center"> What is Your Name?</div>#}
{#             </div>#}
             <div class="col-md-6 d-inline-flex speaker_info_col">
                <div class="title col-4 speaker_info_table_th">{% trans 'Status' %}</div>
                <div class="value col-8 speaker_info_table_td text-right text-center">{{ object.speaker_status }} </div>
             </div>

          </div>
         </section>

        <section class="table-section">
            <table class="table py-3 text-center speaker_result" cellspacing="0" id="speaker_result">

                <thead class="">
                <tr class="">
                    <th>{% trans "S. No." %}</th>
                    <th>{% trans "Question Code" %}</th>
                    <th>{% trans "Recorded Date" %}</th>
                    <th>{% trans "Recorded Time" %}</th>
                    <th>{% trans "File Size" %}</th>
                    <th>{% trans "Play" %}</th>
                </tr>
                </thead>

                <tbody>

                {% for question in questions %}
                   <tr>
                   <td> {{ forloop.counter }}</td>
                   <td> {{ question.unique_code }}</td>
                   <td> {% if question.solved %}{{ question.audio_recorded_date|date:'Y-m-d' }}{% else %}-{% endif %}</td>
                   <td > {% if question.solved %}{{ question.audio_recorded_date|date:'h:m:s A' }}{% else %}-{% endif %}</td>
                   <td> {% if question.solved %}{{ question.audio_recording_size }} MB {% else %}-{% endif %}</td>
                   <td>
                     {% if question.solved %}
                     <audio controls class="audio_file" id="audio_{{ question.id }}">
                        <source src="{{ question.audio_url }}" type="audio/mpeg">
                      </audio>
                       {% else %}
                       {% trans 'Not Recorded Yet' %}
                     {% endif %}

                   </td>
                   </tr>
                {% endfor %}
                </tbody>

            </table>
        </section>

    </main>

{% endblock %}

{% block scripts %}
  <script src="{% static 'js/jszip/jszip.min.js' %}"></script>
  <script src="{% static 'js/jszip/utils.js' %}"></script>
  <script src="{% static 'js/jszip/saveas.js' %}"></script>

  <script>

  function download_audios() {
    var urls = [];
     $('.audio_file').each(function (){
          urls.push($(this).find('source').attr('src'))
        })
        console.log('urls', urls)
    var zip = new JSZip();
    var count = 0;
    var count2 = 0;
    var zipFilename = "speaker_recordings.zip";
    var nameFromURL = [];

    var the_arr = "";
    for (var i = 0; i< urls.length; i++){
        the_arr = urls[i].split('/');
        nameFromURL[i] = the_arr.pop();

    }

    urls.forEach(function(url){
        var filename = nameFromURL[count2];
        count2++;
        // loading a file and add it in a zip file
        JSZipUtils.getBinaryContent(url, function (err, data) {
            if(err) {
                throw err; // or handle the error
            }
            zip.file(filename, data, {binary:true});
            count++;
            if (count === urls.length) {
                zip.generateAsync({type:'blob'}).then(function(content) {
                    saveAs(content, zipFilename);
                });
            }
        });
    });
}



  </script>

      <script>



        $('.speaker_result').DataTable({
          dom: 'lfBtp',
          responsive: true,
          buttons: [

            {
                text: "{% trans 'Download All' %}",
                action: download_audios,
                className: " btn-primary active btn btn-sm download_btn dt_right_btn",
            },

        ],

         initComplete: function() {
           $('.dataTables_filter').addClass('dt_right_btn');
           $('.dt_right_btn').closest('div').removeClass('btn-group');
           $('.dt_right_btn').closest('div').addClass('btn-bs-group');
           $('.dt_right_btn').css('margin-right', '10px');
         //  $('.dataTables_length').addClass('dt_right_btn');
         },
          stateSave: false,
          processing: true,

        });






         {% comment %}
        $('form[name=verify-form]').on('submit', function (e) {
            e.preventDefault();
            var $form = $(this);
            $.ajax({
                type: $(this).attr('method'),
                url: $(this).attr('action'),
                data: $(this).serialize(),
                success: function (response) {
                    $form.closest('tr').find('.verification-status').text("{% trans 'Verified' %}");
                    $form.remove();
                }
            });
        });

        $('form[name=block-form]').on('submit', function (e) {
            e.preventDefault();
            var $form = $(this);
            $.ajax({
                type: $(this).attr('method'),
                url: $(this).attr('action'),
                data: $(this).serialize(),
                success: function (response) {
                    $form.closest('tr').find('.active-status').text("{% trans 'Inactive' %}");
                    $form.find('button').text('{% trans 'Unblock' %}')
                }
            });
        });

        $('form[name=unblock-form]').on('submit', function (e) {
            e.preventDefault();
            var $form = $(this);
            $.ajax({
                type: $(this).attr('method'),
                url: $(this).attr('action'),
                data: $(this).serialize(),
                success: function (response) {
                    $form.closest('tr').find('.active-status').text("{% trans 'Active' %}");
                    $form.find('button').text('{% trans 'Block' %}')
                }
            });
        });

        {% endcomment %}
    </script>
{% endblock scripts %}