{% extends "orgadmin/base.html" %}
{% load i18n %}

{% block styles %}
    <style>
        main {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        section {
            margin-block: 1rem;
        }

        .title {
            font-weight: 500;
        }

        .users {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(14rem, 1fr));
            gap: 1rem;
            background-color: white;
            /* padding-block: 1rem; */
        }

        .users a {
            all: unset;
            cursor: pointer;
        }

        .user-card:hover {
            background-color: #444444;
            color: #f0f0f0;
        }

        .user-card.active {
            background-color: #444444;
            color: #f0f0f0;
            box-shadow: 1px 1px 10px 2px rgba(0, 0, 0, 0.2);
        }

        .user-card {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            border: 2.5px solid lightgrey;
            transition: all 0.3s ease-in-out;
        }

        .user-card .right-side {
            display: flex;
            flex-direction: column;
        }

        .new-additions, .time {
            display: flex;
            flex-direction: column;
            padding: 0rem 0.45rem 0 0.25rem;
            font-size: 0.9rem;
            font-weight: 500;
            border-radius: 0.25rem;
            background-color: rgba(0, 0, 0, 0.05);
            color: #0ab2a9;
        }

        .count {
            font-weight: 600;
            font-size: 1.5rem;
        }
    </style>
{% endblock %}

{% block content %}
    <section>
        <h2 class="my-3 title">{% trans 'Contract List' %}</h2>
        <div class="users">
            <a href="{% url 'speaker_contract' %}">
                <div class="user-card {% if not request.GET.status %}active{% endif %}">
                    <div class="right-side">
                        <div>
                            <i class="fa-solid fa-users"></i>
                            <span class="count"> {{ total }}</span>
                        </div>
                        <span class="title"> {% trans 'Total' %}</span>
                    </div>
                    {#      <span class="new-additions">+98</span>#}
                </div>
            </a>
            <a href="{% url 'speaker_contract' %}?status=pending">
                <div class="user-card {% if request.GET.status == 'pending' %}active{% endif %}">
                    <div class="right-side">
                        <div>
                            <i class="fa-solid fa-microphone-lines"></i>
                            <span class="count">{{ pending }}</span>
                        </div>
                        <span class="title"> {% trans 'Pending' %}</span>
                    </div>
                    {#      <span class="new-additions">+98</span>#}

                </div>
            </a>

            <a href="{% url 'speaker_contract' %}?status=verified">
                <div class="user-card {% if request.GET.status == 'verified' %}active{% endif %}">
                    <div class="right-side">
                        <div>
                            <i class="fa-solid fa-person-chalkboard"></i>
                            <span class="count">{{ verified }}</span>
                        </div>
                        <span class="title"> {% trans 'Verified' %}</span>
                    </div>
                    {#                <span class="new-additions">+98</span>#}

                </div>
            </a>

            <a href="{% url 'speaker_contract' %}?status=rejected">
                <div class="user-card {% if request.GET.status == 'rejected' %}active{% endif %}">
                    <div class="right-side">
                        <div>
                            <i class="fa-solid fa-person-digging"></i>
                            <span class="count">{{ rejected }}</span>
                        </div>
                        <span class="title"> {% trans 'Rejected' %}</span>
                    </div>
                    {#                <span class="new-additions">+98</span>#}

                </div>
            </a>
        </div>
    </section>

    <main class="contract-list">

        <section class="table-section">
            <table class="table py-3" cellspacing="0" id="">

                <thead class="">
                <tr class="">
                    <th>{% trans "S. No." %}</th>
                    <th>{% trans "Username" %}</th>
                    <th>{% trans "Name" %}</th>
                    <th>{% trans "Contract File" %}</th>
                    <th>{% trans "Approved Status" %}</th>
                    <th>{% trans "Approval Date" %}</th>
                </tr>
                </thead>

                <tbody>
                {% for contract in object_list %}
                    <tr>
                        <td> {{ forloop.counter }}</td>
                        <td> {{ contract.user.username }}</td>
                        <td> {{ contract.user.get_full_name }}</td>
                        <td>
                            <a href="{{ contract.upload_file.url }}" target="_blank">
                                {{ contract.filename }}
                            </a>
                        </td>
                        <td>
                            <span class="active-status d-flex gap-1">
                                {% if not contract.approved == None %}
                                    {{ contract.approved|yesno:'Approved, Rejected' }}
                                {% else %}
                                    <form name="contract-verify-form" action="{% url 'speaker_contract_verify' contract_id=contract.id %}"
                                          method="post">
                                        {% csrf_token %}
                                        <input type="hidden" value="1" name="is_approved">
                                        <button class="btn btn-dark btn-sm block-btn">{% trans 'Approve' %}</button>
                                    </form>
                                    <form name="contract-verify-form" action="{% url 'speaker_contract_verify' contract_id=contract.id %}"
                                          method="post">
                                        {% csrf_token %}
                                        <input type="hidden" value="0" name="is_approved">
                                        <button class="btn btn-dark btn-sm block-btn">{% trans 'Reject' %}</button>
                                    </form>
                                {% endif %}
                            </span>
                        </td>
                        <td>
                            <span class="approved-date">
                                {% if not contract.approved == None %}
                                    {{ contract.approved_at|date:'Y-m-d h:i a' }}
                                {% else %}
                                    -
                                {% endif %}
                            </span>
                        </td>
                    </tr>
                {% endfor %}
                </tbody>

            </table>
        </section>

    </main>

{% endblock %}

{% block scripts %}
    <script>
        $('.table').DataTable();

        $('form[name=contract-verify-form]').on('submit', function (e) {
            e.preventDefault();
            var $form = $(this);
            var $tr = $form.closest('tr');
            $.ajax({
                type: $(this).attr('method'),
                url: $(this).attr('action'),
                data: $(this).serialize(),
                success: function (response) {
                    var isApproved = response.status;
                    var date = new Date(response.approved_date).toLocaleString();
                    var message = isApproved ? "Approved" : "Rejected";
                    $tr.find('.active-status').text(message);
                    $tr.find('.approved-date').html(date);
                }
            });
        });
    </script>
{% endblock scripts %}